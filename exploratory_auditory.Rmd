---
title: "exploratory_auditory"
output: html_document
---

Import library

```{r}
fafbseg::flywire_connectome_data("syn")
library(malecns)
library(coconatfly)
library(dplyr)
library(tidyr)
library(ggplot2)
library(plotly)
library(stringr)

library(tidygraph)
library(ggraph)
synapse_threshold=5
```

Just fetch some johnston organ neurons

```{r}

sensory.all<-cf_meta(cf_ids(malecns='superclass:sensory'))
sensory.johnston <- sensory.all%>%filter(grepl("JO-",type))
sensory.johnston.song <- sensory.all%>%filter(grepl("JO-A|JO-B",otype))
```

Look at postsynaptic partners of all sensory.johnston.song since there have to be aLN and aPN1

```{r}
sensory.johnston.song.output <-cf_partners(cf_ids(malecns=sensory.johnston.song$id),partners = 'output',threshold=5)
sensory.johnston.song.output.per.unique.cell <- sensory.johnston.song.output %>%
  group_by(partner)%>%
  summarize(total=sum(weight),type=first(type))
#12865 looks promising like aPN1 from 10.1016/j.cub.2014.03.048
```

Look at the inputs of aPN1 if there are more JO-B and if aLN(al) works with it

```{r}
input.CB2556 <- cf_partners(cf_ids(malecns='flywireType:CB2556'),partners = 'in',threshold=5) %>%
  left_join(cf_partners(cf_ids(malecns='flywireType:CB2556'),
                        threshold = synapse_threshold,
                        partners = 'in')%>%
              group_by(bodyid)%>%
              summarize(total.input.to.post=sum(weight))%>%
              as.data.frame(),
            by='bodyid')%>%
  left_join(cf_partners(cf_ids(malecns=cf_partners(cf_ids(malecns='flywireType:CB2556'),
                                                   threshold = synapse_threshold,
                                                   partners = 'in')%>%
                                 pull(pre_id)%>%
                                 unique()),
                        threshold = synapse_threshold,
                        partners = 'out')%>%
              group_by(pre_id)%>%
              summarize(total.output.by.pre=sum(weight))%>%
              as.data.frame(),
            by='pre_id')%>%
  mutate(fraction.of.output=weight/total.output.by.pre,
         fraction.of.input=weight/total.input.to.post)

input.CB2556.summary.across.type.post_id <- input.CB2556%>% 
  group_by(type,post_id) %>% 
  summarize(total=sum(weight),
            sum.fraction.output = sum(fraction.of.output),
            sum.fraction.input = sum(fraction.of.input),
            mean.fraction.output = mean(fraction.of.output),
            mean.fraction.input = mean(fraction.of.input))

input.CB2556.summary.across.type <- input.CB2556%>% 
  group_by(type) %>% 
  summarize(total=sum(weight),
            sum.fraction.output = sum(fraction.of.output),
            sum.fraction.input = sum(fraction.of.input),
            mean.fraction.output = mean(fraction.of.output),
            mean.fraction.input = mean(fraction.of.input))

input.CB2556.summary.across.unique.pre.cell <- input.CB2556%>% 
  group_by(pre_id) %>% 
  summarize(total=sum(weight),
            sum.fraction.output = sum(fraction.of.output),
            sum.fraction.input = sum(fraction.of.input),
            mean.fraction.output = mean(fraction.of.output),
            mean.fraction.input = mean(fraction.of.input),
            type=first(type))

input.CB2556.summary.across.unique.post.cell <- input.CB2556%>% 
  group_by(post_id) %>% 
  summarize(total=sum(weight),
            sum.fraction.output = sum(fraction.of.output),
            sum.fraction.input = sum(fraction.of.input),
            mean.fraction.output = mean(fraction.of.output),
            mean.fraction.input = mean(fraction.of.input),
            type=first(type))
```

Connectivity co clustering between flywire and malecns

```{r}
#aLN1 

cf_cosine_plot(cf_ids(malecns="flywireType:CB2556",flywire="CB2556"),interactive=T,partners='out')
cf_cosine_plot(cf_ids(malecns="flywireType:CB2556",flywire="CB2556"),interactive=T,partners='in')
cf_cosine_plot(cf_ids(malecns="flywireType:CB1038",flywire="CB1038"),interactive=T,partners='out')
cf_cosine_plot(cf_ids(malecns="flywireType:CB1038",flywire="CB1038"),interactive=T,partners='in')
cf_cosine_plot(cf_ids(malecns="flywireType:CB1038",flywire="CB1038"),interactive=T,partners=c("outputs", "inputs"))

```

Malecns flywire type matching

```{r}
data1.cb4090 <- cf_meta(cf_ids(flywire='malecns_type:CB4090')) %>%
  rename_with(~ str_replace_all(.x, c(
      "flywireType" = "flywire",
      "flywire_type" = "flywire",
      "hemibrainType" = "hemibrain",
      "hemibrain_type" = "hemibrain",
      'malecns_type' = 'malecns',
      'malecns_type' = 'malecns',
      "type" = 'type1'
    )))%>%
  select(any_of(c('id',
                  'type1',
                  'type2',
                  'flywire',
                  'hemibrain',
                  'malecns')))

data2.cb4090 <- cf_meta(cf_ids(malecns='flywireType:CB4090')) %>%
  rename_with(~ str_replace_all(.x, c(
      "flywireType" = "flywire",
      "flywire_type" = "flywire",
      "hemibrainType" = "hemibrain",
      "hemibrain_type" = "hemibrain",
      'malecns_type' = 'malecns',
      'malecns_type' = 'malecns',
      "type" = 'type2'
    )))%>%
  select(any_of(c('id',
                  'type1',
                  'type2',
                  'flywire',
                  'hemibrain',
                  'malecns')))




#create graph
edges1 <- data1.cb4090 %>% 
  pivot_longer(!id,
               names_to = 'dataset',
               values_to = "type")%>%
  select(id,type)%>%
  filter(!is.na(type))

edges2 <- data2.cb4090 %>% 
  pivot_longer(!id,
               names_to = 'dataset',
               values_to = "type")%>%
  select(id,type)%>%
  filter(!is.na(type))

edges<-rbind(edges1,edges2)
nodes<-  edges %>% 
    pivot_longer(cols = everything(), values_to = "id")%>%
  select(id)%>%
    distinct()

graph <- tbl_graph(nodes = nodes, edges = edges, directed = FALSE)
ggraph(graph, layout = "fr") +
    geom_edge_link(aes(), alpha = 0.5) +  # Draw edges
    geom_node_point(size = 5, color = "blue") +  # Nodes as points
    geom_node_text(aes(label = id), repel = TRUE) +  # Labels
    theme_void()



```

Try make a postsynaptic difference plot for these neurons

```{r}
  #other potential aPN1 CB1076, CB3710, CB2521, CB1425, CB1078, CB1038
  #other potential aLN CB1427


cell_types <- c("CB3207", "CB2380", "CB2556")  #Conservative
cell_types <- c('CB1076', 'CB3710', 'CB2521', 'CB1425', 'CB1078', 'CB1038', 'CB1427', 'CB2556','CB2380','CB2556')  #ALL


cf_list <- lapply(cell_types, function(ct) {
  cf_ids(malecns = paste0("flywireType:", ct), flywire = ct)
})

all.auditory.output <- cf_partners(do.call(c, cf_list), partners = 'out', threshold = synapse_threshold)



all.auditory.type.summary <- all.auditory.output %>% 
  left_join(cf_partners(all.auditory.output%>%
                          pull(post_key)%>%
                          unique(),
                        threshold = synapse_threshold,
                        partners = 'in')%>%
              group_by(post_id)%>%
              summarize(total.input.to.post=sum(weight))%>%
              as.data.frame(),
            by='post_id')%>%
  left_join(cf_meta(all.auditory.output %>%
                          filter(dataset=='malecns')%>%
                          pull(post_key)%>%
                          unique())%>%
              mutate(id=as.integer(id))%>%
              select(id,dimorphism,fruDsx,flywireType), 
              by=c('post_id'='id'))%>%
  mutate(fraction.of.input=weight/total.input.to.post)%>%
  mutate(type = if_else(
    type != flywireType & !is.na(flywireType),  # Condition: type differs & flywireType is not NA
    if_else(grepl("[a-zA-Z]$", flywireType),    # If last character is a letter
            substr(flywireType, 1, nchar(flywireType) - 1),  # Remove last character
            flywireType),  # Otherwise, keep flywireType as is
    type  # If condition is not met, keep the original type
  ))%>%
  mutate(type = if_else(grepl("[a-zA-Z]$", type),    # If last character is a letter
            substr(type, 1, nchar(type) - 1),
         type))%>%
  group_by(type,dataset)%>%
  summarize(total=sum(weight),
            mean.fraction.of.input=mean(fraction.of.input),
            sum.fraction.of.input=sum(fraction.of.input),
            dimorphism=first(dimorphism))%>%
  ungroup()%>%
  complete(type, 
           dataset, 
           fill = list(total = 0)) %>%
  arrange(desc(total))%>%
  pivot_wider(id_cols = c(type, dimorphism),
              names_from=dataset,
              values_from = c(total,
                              mean.fraction.of.input,
                              sum.fraction.of.input))%>%
  mutate(across(everything(),
                ~ replace(., is.na(.), 0)))%>%
  mutate(dimorphism=if_else(dimorphism==0,NA,dimorphism))


```

Scatter plot of inputs of male vs female auditory neurons

```{r}
p<-ggplot(all.auditory.type.summary, aes(x = total_malecns, 
                                         y = total_flywire,
                                         text=type,
                                         color = dimorphism)) +
  geom_point(size = 1, alpha = 0.7) +
  theme_minimal() +
  labs(title = "Absolute output to types by auditory aLNs and aPN1s",
       x = "malecns",
       y = "flywire",
       color = "Dataset") +
  geom_abline()+
  theme_minimal()

ggplotly(p, tooltip = "text")

p<-ggplot(all.auditory.type.summary, aes(x = mean.fraction.of.input_malecns,
                                         y = mean.fraction.of.input_flywire,
                                         text=type,
                                         color = dimorphism)) +
  geom_point(size = 1, alpha = 0.7) +
  theme_minimal() +
  labs(title = "Mean fraction output to types by auditory aLNs and aPN1s",
       x = "malecns",
       y = "flywire",
       color = "Dataset") +
  geom_abline()+
  theme_minimal()
ggplotly(p, tooltip = "text")


p<-ggplot(all.auditory.type.summary, aes(x = sum.fraction.of.input_malecns,
                                         y = sum.fraction.of.input_flywire,
                                         text=type,
                                         color = dimorphism)) +
  geom_point(size = 1, alpha = 0.7) +
  theme_minimal() +
  labs(title = "sum fraction output to types by auditory aLNs and aPN1s",
       x = "malecns",
       y = "flywire",
       color = "Dataset") +
  geom_abline()+
  theme_minimal()
ggplotly(p, tooltip = "text")

```
